<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LemonDB: README.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">LemonDB
   </div>
   <div id="projectbrief">A simple key-value database by Lemonion. Inc.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">README.md</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# LemonDB</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;## Introduction</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;A simple multi-thread key-value database by Lemonion. Inc. </div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;See more information in our official documentation [HTML](https://tc-imba.github.io/VE482-p2/)/[PDF](../latex/refman.pdf)</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;## Compilation</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;### Debug</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;This version is used for debugging.</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;```</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;mkdir debug &amp;&amp; cd debug</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;cmake ..  -DCMAKE_BUILD_TYPE=Debug</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;make lemondb</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;src/lemondb</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;```</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;### Release</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;This version is used for performance test.</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;```</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;mkdir release &amp;&amp; cd release</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;cmake ..  -DCMAKE_BUILD_TYPE=Release</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;make lemondb</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;src/lemondb</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;```</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;## Testing</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;For a small test case, just use the files under `test` folder. Set the working directory as `test`, set the program argument as `test.query` or `test*.in`.</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;The test cases are too bug, so they are stored with Git LFS. See more information on [Git LFS pages](https://git-lfs.github.com/).</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;Once Git LFS extension is installed, you can download the test cases through cloning the submodule:</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;```</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;git submodule init</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;git submodule update</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;```</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;Set the working directory as `testcase/sample`, set the program argument as `*.query`, simply start debugging!</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;(The loading query in all test files should be based on `testcase/sample` directory)</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;## Documentation</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;The working flow of LemonDB is written by ourselves.</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;The class / function documentation is generated by [Doxygen](http://www.doxygen.nl/).</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;### Design</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;* We design this program to make it can create 8 threads. We classify the queries using table and add them into queryqueue of corresponding table when we read them from the file. Once the table needed has been loaded completely, we will execute the queries as the order in queue and read query if the file hasn&#39;t ended at the same time.</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;* Queries in the queryqueue will be run in the parallel.</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;* Even in one query, for data queries that need searching and calculation such as SUB or SUM in a large table, we use a function addIterationTask to divide the table into several parts and search or calculate these parts simultaneously. Because the efficiency depends on the ratio between size of every part and size of the table, we did experiments and then find 10000 is a good size. For queries like TRUNCATE and INSERT, since they don&#39;t have to traverse the whole table, we don&#39;t add task for them.  </div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;* The query class will use a &quot;combine&quot; function to check whether all the tasks dispatched by one query are all finished and organize them in the order and show on the screen. </div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;* When the user ask for quit, the quit query will check whether all tasks have already finished and and exit the program.</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;### Performance Improvement</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;We use many tricks to improve performance:</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;* Since we use a vector to store all data in a table, we obtain the advantage of efficient random access. Meanwhile, deleting and inserting datum becomes less efficient inevitably. However, we use some tricks to handle this issue. Notice that the vector is unordered, so for INSERT query it can be trivially appended to the vector with O(1). Then for DELETE and DUPLICATE query, we use a temporary vector `dataNew`. When iterating through data, those won&#39;t be deleted will be moved to dataNew by `std::move`, which is extremely fast. Then we simply swap `data` and `dataNew`, clear `dataNew` for further use. For DUPLICATE, things are slightly different. We insert duplicated data into `dataNew`, and then we append `dataNew` to `data`. These iteration can be executed in parallel, so `dataNew` is, of course, protected by a mutex.</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;* Another great improvement is for those query with a condition &#39;KEY = someKey&#39;. Making use of efficient random access, we keep a `keyMap` which stores index for given key. With this map, we can complete those query very efficiently, without iterating through data.</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;* For those query without given key, we also improve the speed of evaluating condition. This is done by computing the condition explicitly for a specific query (by `std::function`), and simply pass this function to it. By doing so, we don&#39;t need to repeatedly compare string, convert string to integer, even switch among operators. This can save huge amount of time, because originally every datum use one general evaluating function. Now we just need to compute it once per query.</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;* In some trivial cases atomic_int is used instead of having a mutex because it is much faster.</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;### Problems Solved</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;Due to our sophisticated design, we ran into many problems. These are some of them:</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;* We have encountered many problems about the query queue. The problem of LOAD query is the most difficult one, because it doesn&#39;t specify a table name. In our design, every table has a query queue so that we can decide the order to execute them, following reader/writer pattern. But LOAD doesn&#39;t have it, so it&#39;s very difficult to deicide where to put it, because the file may even not exist when the query is parsed and put into some queue. DUMP query is the reason we concern about this issue, so we solve it by keeping a map from filename to tablename. With this map, LOAD can decide whether the file is (or will be) created by DUMP or should exist already.</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;* Another issue is COPYTABLE. This is the other query which can create a table, in which case it is responsible for starting the query queue to execute. And the problem is that COPYTABLE involves 2 table, so it should be pushed to both tables. And only when both query queues come to this query should it execute. This is done by keeping each other&#39;s pointer in it.</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;* Other problems such as mutex or deadlock are less encountered, because we consider carefully about implementation before we start to code.</div></div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
